<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="custom.css">

<script type="text/javascript" src="colorpicker.js"></script>
<link rel="stylesheet" type="text/css" href="themes.css" />


<script src="bootstrap.js"></script>
<script src="custom.js"></script>
<script src="jquery-3.2.1.min.js"></script>
<script src="js/index.js"></script>

<!-- <script src="jquery.minicolors.js"></script>
<link rel="stylesheet" href="jquery.minicolors.css"> -->
<!-- <script> data = JSON.parse('[{"question":"why","options":["option1","option2"]},{"question":"what","options":["option1","option2"]},{"question":"where","options":["option1","option2"]},{"question":"who","options":["option1","option2"]}]') </script> -->
<!-- <script> data = JSON.parse('[{"id":1,"question":"Who will be using HUEAssist?","options":["Me","Someone Else"]},{"id":2,"question":"Do you have any of the following conditions?","options":["Colour Blindness","Dementia","C.I.P","Other"]},{"id":"3","question":"Do you have another condition?","options":["Yes","No"]},{"id":"4","question":"who","options":["option1","option2"]}]') </script> -->
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand" href="#">HueAssist</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">Setup<span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Connect</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Features</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Help</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
  <div id ="content" class="row">
 <div class="col-sm-9"><div id="main"></div></div>
 <div id="sidebar" class="col-sm-3"><h4 id="infoTitle">This is a test of a heading</h4> <h6 id="infoDescription">test</h6></div>
 </div>
<div id="main"></div>
</div>
<style>
.loader,
.loader:before,
.loader:after {
  border-radius: 50%;
  width: 2.5em;
  height: 2.5em;
  -webkit-animation-fill-mode: both;
  animation-fill-mode: both;
  -webkit-animation: load7 1.8s infinite ease-in-out;
  animation: load7 1.8s infinite ease-in-out;
}
.loader {
  color: black;
  font-size: 10px;
  margin: 80px auto;
  position: relative;
  text-indent: -9999em;
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-animation-delay: -0.16s;
  animation-delay: -0.16s;
}
.loader:before,
.loader:after {
  content: '';
  position: absolute;
  top: 0;
}
.loader:before {
  left: -3.5em;
  -webkit-animation-delay: -0.32s;
  animation-delay: -0.32s;
}
.loader:after {
  left: 3.5em;
}
@-webkit-keyframes load7 {
  0%,
  80%,
  100% {
    box-shadow: 0 2.5em 0 -1.3em;
  }
  40% {
    box-shadow: 0 2.5em 0 0;
  }
}
@keyframes load7 {
  0%,
  80%,
  100% {
    box-shadow: 0 2.5em 0 -1.3em;
  }
  40% {
    box-shadow: 0 2.5em 0 0;
  }
}

.sidebar{
  position: fixed;
  display:block;
}
    .node {}

      .disabledbutton {
    pointer-events: none;
    opacity: 0.4;
}
.full-spectrum .sp-palette {
max-width: 200px;
}

h4 {
    text-decoration: underline;
}

    .buttonContain {
        text-align: justify;
        display: inline-block;
    }
</style>
<script>
    //Features
    var features = JSON.parse('[{"name":"Ping","description":"To quickly test the bulb connectivity, this function sends a signal to all connected bulbs to universally change to one colour and back again.","settings":[{"type":"colour","defValue":"blue"}]}]');

    //Question and answers in the form of JSON
    var data = JSON.parse('[{"id":1,"heading":"We re here to help guide you.","description":"Read through each of the questions on the left hand side and select the answer accordingly.Don t sorry if you make a mistake, just click the colourful back button to go a step! HUEAssist is designed to support you.","question":"Who will be using HUEAssist?","options":[{"name":"Me","target":2},{"name":"Someone Else","target":4}]},{"id":2,"heading":"Help us, Help You.","description":"Telling us any conditions you suffer from can help us customise the options just for you. Don t worry about your medical data leaking becuase we haven t met anyone who s willing to pay us for it yet.","question":"Do you have any of the following conditions?","options":[{"name":"Colour Blindness","target":2.1},{"name":"Dementia","target":2.2},{"name":"C.I.P","target":3},{"name":"None","target":4}]},{"id":"2.1","question":"What type of colourblindness?","heading":"Colour Vision Deficiency (CVD)","description":"Telling us which type of colourblindness you have allows us to enhance the Hue experience, Colour pallets will be generated and will excluded colours that aren t relvent to you. No need to panic, we have you back, mate!","options":[{"name":"Red-Green","target":3},{"name":"Blue-Yellow","target":3},{"name":"Complete","target":3}]},{"id":"2.2","question":"How Severe is your Dementia?","heading":"Global Deterioration Scale (GDS)","description":"A sensitive subject, but an important one. This information will adjust the aggression of the Hue lights. Warning/Notifications and Alarms will be brighted and more frequent.","options":[{"name":"Early-stage (4)","target":3},{"name":"Mid-stage (5-6)","target":3},{"name":"Late-stage (7)","target":3}]},{"id":"3","question":"Do you have another condition?","heading":"We re adding more all the time!","description":"Thanks to the internet, we ve been able to research the most obscure, rare and outright hilarious diseases and infections. We re constantly coming up with new ways we can make money so stay tuned!","options":[{"name":"Yes","target":2},{"name":"No","target":4}]},{"id":"4","question":"Lets Connect to your Hue.","heading":"Fuck. It s been fun.","description":"I ll never forget you, how could I? With blue eyes, long hair like that and stage 5 dementia theres no way I could forget you.","options":[{"name":"Connect!","target":0}]}]');
    var counter = 0;
    var currentQuestionID = 1;
    var answers = [];
    var backColours = ["btn-success","btn-info","btn-warning","btn-danger"];
    var colourindex = 0;
    var randID = Math.random();

    var currentQuestion;
    var previousQuestion;
    // answers.pop({"question":getTargetQuestion(data,1).question,"answer":
    //This is so we can distinguish two differnt instances of the same question (state 2 and 3)

    newQuestion(1);

    function updateInfo(question)
    {
      previousQuestion = question;
      var heading = document.getElementById("infoTitle");
      var description = document.getElementById("infoDescription");
      heading.innerHTML = question.heading;
      description.innerHTML = question.description;
    }
    function onBackClick(){
      removeQuestion();

      //gets previous question
      var questionToRestore = answers.pop();
      answers.push(questionToRestore);

      //resets randomID
      randID = questionToRestore.randID;

      updateInfo(getTargetQuestionByQuestion(data,questionToRestore.question));
      restoreQuestion();
      answers.pop();


    }
    function removeQuestion(){
      var nodeId = "node" + randID;
      var elem = document.getElementById(nodeId);

      elem.remove();
    }
    function getTargetQuestionByQuestion(source, target) {
        for (var i = 0; i < source.length; i++)
        {
            if (source[i].question == target) {
                return source[i];
            }
        }
    }

    function getTargetQuestion(source, target) {
        for (var i = 0; i < source.length; i++)
        {
            if (source[i].id == target) {
                return source[i];
            }
        }
    }
    function newQuestion(index) {

        currentQuestionID = index;
        counter +=1;
        //gets chosen question

        var chosen = getTargetQuestion(data, index)

        //gets the container
        var main = document.getElementById('main');

        //creates question node
        main.innerHTML += '<div class="node" id="node' + randID + '">';

        //heading
        var node = document.getElementById('node' + randID);
        node.innerHTML += '<h1 id="heading">' + chosen.question + '</h1>';

        //text
        currentQuestion = chosen;
        updateInfo(chosen);

        //Buttons
        node.innerHTML += '<div id="button' + randID + '" class="buttonContain">';

        var buttonContain = document.getElementById('button' + randID);



        if(colourindex == backColours.length ){
          colourindex = 0;
        }
        backColour = backColours[colourindex];
        //Back Button
        if(counter> 1)
        {
            colourindex += 1;
            buttonContain.innerHTML += '<button type="button" onClick="onBackClick()" class="btn '+backColour+' btn-l">â†±</button> ';
        }

        var numOfOptions = chosen.options.length;
        for (var i = 0; i < numOfOptions; i++) {

          var answer = chosen.options[i].name;
          var target = chosen.options[i].target;

             // buttonContain.innerHTML += '<button type="button" onClick="onOptionClick(' + chosen.options[i].target +',' +chosen.options[i].name +'")" class="btn btn-default btn-l">' + chosen.options[i].name + '</button> ';
             buttonContain.innerHTML += '<button type="button" onClick="onOptionClick('+`'`+answer+`'`+','+target+')" class="btn btn-default btn-l">' + answer + '</button> ';

        }
        currentQuestion = chosen;

    }

    const hue = jsHue();
    let ip = '';
    let lights = 0;
    let bridge;
    let username;

    function startSearching(){
      findHue();
      connectBridge();
    }

    function changeLights(bri, hue, sat, on) {
      user.getLights().then((res) => {
        for(i in res) {
          //console.log(i)
          lights + 1;
          changeLight(i, bri, hue, sat, on)
        }
      })
    }
    function changeLight(num, bri, hue, sat, on) {

      user.setLightState(num, {"on": on,"bri": bri,"sat": sat,"hue": hue})
    }
    function party(){
      let max = 65280;
      let min = 0;
      let rand = Math.floor(Math.random() * (max - min) + min);
      console.log(rand);
      changeLights(255, rand, 255, true);
    }
    function party2() {
      for(let i=1; i <= 3; i++) {
        let max = 65280;
        let min = 0;
        let rand = Math.floor(Math.random() * (max - min) + min);
        console.log(rand);
        changeLight(i, 255, rand, 255, true);
      }
    }
    function connectBridge(){
      bridge = hue.bridge(ip);
      console.log(bridge);
      // create user account (requires link button to be pressed)
      bridge.createUser('myApp#testdevice').then(data => {

        if(data[0].error !== undefined){
            console.log(data[0].error.description);

          }else{

            // extract bridge-generated username from returned data
            username = data[0].success.username;

            console.log('New username:', username);

            // instantiate user object with username
            user = bridge.user(username);

            //user.setLightState(1, { on: true }).then(data => {
            // process response data, do other things
            //});

            showFunctions();

          }
      });
    }
    function findHue(){
      hue.discover().then(bridges => {
        if(bridges.length === 0) {
            console.log('No bridges found. :(');
        }
        else {
            bridges.forEach(b =>  {ip = b.internalipaddress
                                    console.log(ip)
                                  });
        }
      }).catch(e => console.log('Error finding bridges', e));

    }

    //loop through all functions and generate
    function showFunctions(){
      var mainContent = document.getElementById('content');
      //divides page into 50/50
      mainContent.innerHTML = '<div class="col-sm-6" id="leftSide"></div><div class="col-sm-6" id="rightSide"></div>';

      for (var i = 0; i < features.length; i++) {
        generateFeatureButton(features[i].name);
      }
    }

function generateFeatureButton(name)
{
  //onclick function will be in the form of feature + feature.name. for exmaple featurePing();
   leftSide.innerHTML += '<button type="button" class="btn btn-default btn-l" onclick="featurebuttonClick('+`'`+name+`'`+')">'+name+'</button> ';
}

function featurebuttonClick(name)
{
  console.log(name);
  showFeatureSettings(name);
}

function showFeatureSettings(name){
  var result = $.grep(features, function(e){ return e.name == name; });
  console.log(result);
  var rightSide = document.getElementById('rightSide');
  var settings = result[0].settings;
  console.log(settings);
  for (var i = 0; i < settings.length; i++) {
    var settingType = settings[i].type;
    if(settingType == "colour")
    {
      rightSide.innerHTML += '<div id="color-picker" class="cp-default"></div>';
      ColorPicker(
        document.getElementById('color-picker'),
        function(hex, hsv, rgb) {
          console.log(hsv.h, hsv.s, hsv.v);         // [0-359], [0-1], [0-1]
          // console.log(rgb.r, rgb.g, rgb.b);         // [0-255], [0-255], [0-255]
          party();
        });
    }
  }
}



    function wipeScreen()
    {
      var mainContent = document.getElementById('content');
      mainContent.innerHTML = '<div class="col-sm-9" style="text-align: center;"><h2>Searching for Hue Bridge.</h2><h5>Remember to press the Link button</h5><button type="button" class="btn btn-default btn-l" onclick="startSearching()">Connect</button><div class="loader">Loading...</div></div><div class="col-sm-3"></div>';
    }



    function onOptionClick(answer,target) {

        if(target==0)
        {
          wipeScreen();
          return 0;
        }
        answers.push({
            "question": getTargetQuestion(data, currentQuestionID).question,
            "answer": answer,
            "randID": randID
        });
        console.log(answers);
        dimQuestion();
        randID = Math.random();
        newQuestion(target);
      }

      function restoreQuestion(){
        var node = document.getElementById('node'+randID);
        var containId = "button"+randID;

        //reenable Buttons
        var nodes = document.getElementById(containId).getElementsByTagName('*');
        for(var i = 0; i < nodes.length; i++){
             nodes[i].disabled = false;
        }
        node.style.color = "black";

        //Text and stuff

      }

      function startTimer(hr,min,sec){
        var x = {
            hours: hr,
            minutes: min,
            seconds: sec
          };

          var dtAlarm = new Date();
          dtAlarm.setHours(x.hours);
          dtAlarm.setMinutes(x.minutes);
          dtAlarm.setSeconds(x.seconds);
          var dtNow = new Date();

          if (dtAlarm - dtNow > 0) {
            console.log('Later today, no changes needed!');
          }
          else {
            console.log('Tomorrow, changing date to tomorrow');
            dtAlarm.setDate(dtAlarm.getDate() + 1);
          }

          var diff = dtAlarm - new Date();
          setTimeout(function(){ alert("Hello"); }, diff);

      }
      function dimQuestion(){
        //I can simply get the head of the queue
        var previousQuestionID = answers[answers.length-1].randID;
        var node = document.getElementById('node'+previousQuestionID);
        node.style.color = "grey";
        var containId = "button"+previousQuestionID;
        var nodes = document.getElementById(containId).getElementsByTagName('*');
        for(var i = 0; i < nodes.length; i++){
             nodes[i].disabled = true;
        }

      }

      </script>
